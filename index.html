<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スピーカー設計：レスポンシブPro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { --accent: #44ff44; --bg: #1a1a1a; --panel: rgba(0,0,0,0.85); }
        body { margin: 0; background: var(--bg); color: #eee; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        
        /* レスポンシブ・コンテナ */
        #container { display: flex; height: 100vh; width: 100vw; flex-direction: row; }
        @media (max-width: 800px) { #container { flex-direction: column; } }

        /* UIパネル */
        #ui { 
            background: var(--panel); padding: 20px; border-right: 1px solid #444; 
            width: 350px; overflow-y: auto; z-index: 100; box-sizing: border-box;
        }
        @media (max-width: 800px) { 
            #ui { width: 100%; height: 45%; border-right: none; border-bottom: 1px solid #444; } 
        }

        /* 入力グリッド */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .full { grid-column: span 2; }

        h3 { margin: 0 0 15px 0; color: var(--accent); font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 5px; }
        label { display: block; font-size: 10px; color: #aaa; margin-bottom: 3px; font-weight: bold; }
        input { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        .result-box { background: #000; padding: 15px; border-radius: 6px; margin-top: 15px; border-top: 2px solid var(--accent); }
        .result-box h4 { margin: 0 0 10px 0; font-size: 12px; color: var(--accent); }
        
        .cut-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-bottom: 10px; }
        .cut-table th { text-align: left; color: #888; font-size: 10px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .cut-table td { padding: 8px 0; border-bottom: 1px solid #222; }
        
        #csvOutput { width: 100%; background: #111; border: 1px solid #333; color: var(--accent); font-family: monospace; font-size: 11px; padding: 8px; border-radius: 4px; box-sizing: border-box; height: 70px; resize: none; }
        
        .volume-display { color: var(--accent); font-size: 1.3rem; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .warning { color: #ff4444; font-weight: bold; background: rgba(255,0,0,0.15); padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; border: 1px solid #ff4444; display: none; }
        
        /* 3D領域 */
        #canvas-container { flex-grow: 1; position: relative; background: #000; }
        canvas { width: 100% !important; height: 100% !important; display: block; }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui">
            <h3>設計パラメーター</h3>
            <div id="warn" class="warning">⚠️ ユニットが裏板に干渉中</div>
            
            <div class="grid">
                <div class="input-group"><label>板厚 (t) mm</label><input type="number" id="inT" value="12"></div>
                <div class="input-group"><label>外寸 幅 (W) mm</label><input type="number" id="inW" value="450"></div>
                <div class="input-group"><label>外寸 高 (H) mm</label><input type="number" id="inH" value="450"></div>
                <div class="input-group"><label>外寸 奥 (D) mm</label><input type="number" id="inD" value="410"></div>
                <div class="input-group"><label>穴径 φ mm</label><input type="number" id="inHole" value="283"></div>
                <div class="input-group"><label>SP奥行 mm</label><input type="number" id="inUnitD" value="150"></div>
                <div class="input-group full"><label>補強板（窓枠）の数</label><input type="number" id="inBrace" value="2" min="0"></div>
            </div>

            <div class="result-box">
                <h4>内容積・計算</h4>
                <div class="volume-display"><span id="liters">0.0</span> L</div>
                <div id="logicArea" style="font-size:10px; color:#666; font-family:monospace; text-align:center;"></div>
            </div>

            <div class="result-box">
                <h4>カットリスト（CSV）</h4>
                <table class="cut-table">
                    <thead><tr><th>部位</th><th>寸1</th><th>寸2</th><th>数</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <textarea id="csvOutput" readonly onclick="this.select()"></textarea>
            </div>
        </div>

        <div id="canvas-container"></div>
    </div>

    <script>
        let scene, camera, renderer, controls, group;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, 1, 1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            const container = document.getElementById('canvas-container');
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            camera.position.set(800, 600, 1000);
            group = new THREE.Group(); scene.add(group);

            window.addEventListener('resize', onWindowResize);
            onWindowResize();
            updateModel();
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function updateModel() {
            const t = parseFloat(document.getElementById('inT').value) || 0;
            const W = parseFloat(document.getElementById('inW').value) || 0;
            const H = parseFloat(document.getElementById('inH').value) || 0;
            const D = parseFloat(document.getElementById('inD').value) || 0;
            const holeD = parseFloat(document.getElementById('inHole').value) || 0;
            const unitD = parseFloat(document.getElementById('inUnitD').value) || 0;
            const bCount = parseInt(document.getElementById('inBrace').value) || 0;

            const iW = W - (t * 2);
            const iH = H - (t * 2);
            const iD = D - (t * 2);
            const netLiters = (iW * iH * iD) / 1000000;

            document.getElementById('logicArea').innerText = `式: (${iW} * ${iH} * ${iD}) / 10^6`;
            document.getElementById('liters').innerText = netLiters.toFixed(2);

            while(group.children.length > 0){ group.remove(group.children[0]); }
            const addB = (w, h, d, x, y, z, c, o) => {
                const b = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshPhongMaterial({color: c, transparent:true, opacity:o}));
                b.position.set(x, y, z); group.add(b);
            };

            addB(W, t, D, 0, (H-t)/2, 0, 0x4444ff, 0.7); 
            addB(W, t, D, 0, -(H-t)/2, 0, 0x4444ff, 0.7); 
            addB(t, iH, D, -(W-t)/2, 0, 0, 0xff4444, 0.7); 
            addB(t, iH, D, (W-t)/2, 0, 0, 0xff4444, 0.7);
            addB(iW, iH, t, 0, 0, (D/2)-t/2, 0x44ff44, 0.5); 
            addB(iW, iH, t, 0, 0, -(D/2)+t/2, 0x44ff44, 0.5); 

            const holeWall = new THREE.Mesh(new THREE.CylinderGeometry(holeD/2, holeD/2, t + 0.5, 64, 1, true), new THREE.MeshPhongMaterial({color:0x000000, side:THREE.DoubleSide}));
            holeWall.rotation.x = Math.PI/2; holeWall.position.set(0,0,(D/2)-t/2); group.add(holeWall);

            const u = new THREE.Mesh(new THREE.CylinderGeometry(holeD/2, holeD/4, unitD, 32), new THREE.MeshPhongMaterial({color:0xffaa00, transparent:true, opacity:0.8}));
            u.rotation.x = Math.PI/2; u.position.set(0,0,(D/2)-unitD/2); group.add(u);

            const isCrash = unitD > (D - t);
            document.getElementById('warn').style.display = isCrash ? "block" : "none";

            for(let i=1; i<=bCount; i++) addB(iW, iH, t, 0, 0, (D/2)-(D/(bCount+1))*i, 0x44ff44, 0.3);

            const items = [["天底", W, D, 2], ["側板", iH, D, 2], ["内板", iW, iH, 2 + bCount]];
            let tableHtml = "";
            let csvText = "部位,寸法1,寸法2,数量\n";
            items.forEach(row => {
                tableHtml += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td></tr>`;
                csvText += row.join(",") + "\n";
            });
            document.getElementById('tableBody').innerHTML = tableHtml;
            document.getElementById('csvOutput').value = csvText;
        }

            document.querySelectorAll('input').forEach(el => el.addEventListener('input', updateModel));
            init();
            function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
            animate();
    </script>
</body>
</html>
